AWSTemplateFormatVersion: '2010-09-09'
Description: 'GPUäºˆç´„ã‚·ã‚¹ãƒ†ãƒ  - æœ¬ç•ªç’°å¢ƒç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š'

Parameters:
  Environment:
    Type: String
    Default: production
    Description: ç’°å¢ƒå
  
  TablePrefix:
    Type: String
    Default: gpu-reservation-prod-
    Description: DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
  
  NotificationEmail:
    Type: String
    Description: ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
    Default: admin@gpu-reservation.example.com

Resources:
  # SNS Topic for Alerts
  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${Environment}-gpu-reservation-alerts'
      DisplayName: 'GPUäºˆç´„ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ'
      
  AlertTopicSubscription:
    Type: AWS::SNS::Subscription
    Properties:
      TopicArn: !Ref AlertTopic
      Protocol: email
      Endpoint: !Ref NotificationEmail

  # CloudWatch Dashboard
  SystemDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub '${Environment}-gpu-reservation-dashboard'
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "${TablePrefix}reservations" ],
                  [ ".", "ConsumedWriteCapacityUnits", ".", "." ],
                  [ ".", "ConsumedReadCapacityUnits", "TableName", "${TablePrefix}users" ],
                  [ ".", "ConsumedWriteCapacityUnits", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "ap-northeast-1",
                "title": "DynamoDB å®¹é‡ä½¿ç”¨é‡",
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/DynamoDB", "UserErrors", "TableName", "${TablePrefix}reservations" ],
                  [ ".", "SystemErrors", ".", "." ],
                  [ ".", "UserErrors", "TableName", "${TablePrefix}users" ],
                  [ ".", "SystemErrors", ".", "." ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "ap-northeast-1",
                "title": "DynamoDB ã‚¨ãƒ©ãƒ¼ç‡",
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 24,
              "height": 6,
              "properties": {
                "metrics": [
                  [ "AWS/DynamoDB", "SuccessfulRequestLatency", "TableName", "${TablePrefix}reservations", "Operation", "Query" ],
                  [ "...", "GetItem" ],
                  [ "...", "PutItem" ],
                  [ "...", "UpdateItem" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "ap-northeast-1",
                "title": "DynamoDB ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼",
                "period": 300,
                "stat": "Average"
              }
            }
          ]
        }

  # CloudWatch Alarms

  # DynamoDBèª­ã¿å–ã‚Šå®¹é‡ã‚¢ãƒ©ãƒ¼ãƒˆ
  ReadCapacityAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${Environment}-dynamodb-read-capacity-high'
      AlarmDescription: 'DynamoDBèª­ã¿å–ã‚Šå®¹é‡ä½¿ç”¨ç‡ãŒé«˜ã„'
      MetricName: ConsumedReadCapacityUnits
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 1000
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Sub '${TablePrefix}reservations'
      AlarmActions:
        - !Ref AlertTopic
      TreatMissingData: notBreaching

  # DynamoDBæ›¸ãè¾¼ã¿å®¹é‡ã‚¢ãƒ©ãƒ¼ãƒˆ
  WriteCapacityAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${Environment}-dynamodb-write-capacity-high'
      AlarmDescription: 'DynamoDBæ›¸ãè¾¼ã¿å®¹é‡ä½¿ç”¨ç‡ãŒé«˜ã„'
      MetricName: ConsumedWriteCapacityUnits
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 500
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Sub '${TablePrefix}reservations'
      AlarmActions:
        - !Ref AlertTopic
      TreatMissingData: notBreaching

  # DynamoDBã‚¨ãƒ©ãƒ¼ç‡ã‚¢ãƒ©ãƒ¼ãƒˆ
  ErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${Environment}-dynamodb-error-rate-high'
      AlarmDescription: 'DynamoDBã‚¨ãƒ©ãƒ¼ç‡ãŒé«˜ã„'
      MetricName: UserErrors
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Sub '${TablePrefix}reservations'
      AlarmActions:
        - !Ref AlertTopic
      TreatMissingData: notBreaching

  # DynamoDBãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆ
  LatencyAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${Environment}-dynamodb-latency-high'
      AlarmDescription: 'DynamoDBãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ãŒé«˜ã„'
      MetricName: SuccessfulRequestLatency
      Namespace: AWS/DynamoDB
      Statistic: Average
      Period: 300
      EvaluationPeriods: 3
      Threshold: 100
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Sub '${TablePrefix}reservations'
        - Name: Operation
          Value: Query
      AlarmActions:
        - !Ref AlertTopic
      TreatMissingData: notBreaching

  # Custom Metric Filter for Application Logs
  GeminiAPIErrorFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Sub '/aws/amplify/${Environment}-gpu-reservation'
      FilterPattern: 'ERROR Gemini'
      MetricTransformations:
        - MetricNamespace: 'GPUReservation/Application'
          MetricName: 'GeminiAPIErrors'
          MetricValue: '1'
          DefaultValue: 0

  # Gemini APIã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆ
  GeminiAPIErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${Environment}-gemini-api-errors'
      AlarmDescription: 'Gemini APIã‚¨ãƒ©ãƒ¼ãŒé »ç™º'
      MetricName: GeminiAPIErrors
      Namespace: GPUReservation/Application
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref AlertTopic
      TreatMissingData: notBreaching

  # Reservation Creation Rate Monitor
  ReservationRateFilter:
    Type: AWS::Logs::MetricFilter
    Properties:
      LogGroupName: !Sub '/aws/amplify/${Environment}-gpu-reservation'
      FilterPattern: 'reservation created'
      MetricTransformations:
        - MetricNamespace: 'GPUReservation/Business'
          MetricName: 'ReservationsCreated'
          MetricValue: '1'
          DefaultValue: 0

  # äºˆç´„ä½œæˆç‡ç›£è¦–
  ReservationRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub '${Environment}-reservation-rate-low'
      AlarmDescription: 'äºˆç´„ä½œæˆç‡ãŒç•°å¸¸ã«ä½ã„'
      MetricName: ReservationsCreated
      Namespace: GPUReservation/Business
      Statistic: Sum
      Period: 3600
      EvaluationPeriods: 2
      Threshold: 1
      ComparisonOperator: LessThanThreshold
      AlarmActions:
        - !Ref AlertTopic
      TreatMissingData: breaching

Outputs:
  DashboardURL:
    Description: 'CloudWatch Dashboard URL'
    Value: !Sub 'https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#dashboards:name=${Environment}-gpu-reservation-dashboard'
    Export:
      Name: !Sub '${Environment}-dashboard-url'

  AlertTopicArn:
    Description: 'SNS Topic ARN for alerts'
    Value: !Ref AlertTopic
    Export:
      Name: !Sub '${Environment}-alert-topic-arn'

  MonitoringSetup:
    Description: 'ç›£è¦–è¨­å®šå®Œäº†'
    Value: !Sub |
      ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚
      
      ğŸ“Š Dashboard: https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#dashboards:name=${Environment}-gpu-reservation-dashboard
      
      ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥å…ˆ: ${NotificationEmail}
      
      ğŸ“ˆ ç›£è¦–é …ç›®:
      - DynamoDBå®¹é‡ä½¿ç”¨ç‡
      - ã‚¨ãƒ©ãƒ¼ç‡ãƒ»ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼
      - Gemini APIã‚¨ãƒ©ãƒ¼
      - äºˆç´„ä½œæˆç‡
      
      è¨­å®šå®Œäº†å¾Œã€ãƒ¡ãƒ¼ãƒ«ç¢ºèªã§SNSè³¼èª­ã‚’æ‰¿èªã—ã¦ãã ã•ã„ã€‚
